{{ define "main" }}
<div class="container">
    <header class="page-header fade-in">
        <h1>{{ .Title }}</h1>
        {{ if .Params.subtitle }}
        <p class="subtitle">{{ .Params.subtitle }}</p>
        {{ end }}
    </header>

    <nav class="nav-menu fade-in">
        <ul>
            <li><a href="{{ "/" | relURL }}">トップページ</a></li>
            {{ range .Site.Pages }}
                {{ if eq .Type "posts" }}
                    <li><a href="{{ .Permalink }}" {{ if eq .Title $.Title }}class="active"{{ end }}>{{ .Title }}</a></li>
                {{ end }}
            {{ end }}
        </ul>
    </nav>

    <main class="content fade-in">
        {{ .Content }}
    </main>

    <button class="scroll-top">↑</button>
</div>

<script>
    // フェードイン効果
    document.addEventListener('DOMContentLoaded', function() {
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);

        // すべての.fade-in要素を監視
        document.querySelectorAll('.fade-in').forEach(function(element) {
            observer.observe(element);
        });

        // 最初の要素は即座に表示
        const firstElement = document.querySelector('.fade-in');
        if (firstElement) {
            firstElement.classList.add('visible');
        }
    });

    // スクロールトップボタン
    window.addEventListener('scroll', function() {
        const scrollTop = document.querySelector('.scroll-top');
        if (window.pageYOffset > 300) {
            scrollTop.style.display = 'block';
        } else {
            scrollTop.style.display = 'none';
        }
    });

    document.querySelector('.scroll-top').addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    // スムーススクロール
    document.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // 検索ワードハイライト機能
    let currentHighlightIndex = 0;
    let highlightElements = [];

    function highlightSearchTerms() {
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('highlight');

        if (searchQuery) {
            const searchTerms = searchQuery.toLowerCase().split(/\s+/).filter(term => term.length > 1);
            const contentArea = document.querySelector('.content');

            if (contentArea && searchTerms.length > 0) {
                const walker = document.createTreeWalker(
                    contentArea,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );

                const textNodes = [];
                let node;
                while (node = walker.nextNode()) {
                    textNodes.push(node);
                }

                textNodes.forEach(textNode => {
                    let text = textNode.textContent;
                    let hasMatch = false;

                    searchTerms.forEach(term => {
                        const regex = new RegExp(term, 'gi');
                        if (regex.test(text)) {
                            hasMatch = true;
                            text = text.replace(regex, `<mark class="search-highlight">$&</mark>`);
                        }
                    });

                    if (hasMatch) {
                        const span = document.createElement('span');
                        span.innerHTML = text;
                        textNode.parentNode.replaceChild(span, textNode);
                    }
                });

                // ハイライト要素を収集
                highlightElements = Array.from(document.querySelectorAll('.search-highlight'));

                if (highlightElements.length > 0) {
                    // 各ハイライト要素にインデックスを追加
                    highlightElements.forEach((element, index) => {
                        element.setAttribute('data-highlight-index', index);
                    });

                    // 最初のハイライト箇所にスクロールして強調
                    setTimeout(() => {
                        scrollToHighlight(0);
                        showHighlightInfo();
                    }, 500);

                    // Enterキーでの移動機能を有効化
                    enableHighlightNavigation();
                }
            }
        }
    }

    function scrollToHighlight(index) {
        if (highlightElements.length === 0) return;

        // 前の現在位置の強調を解除
        const prevElement = highlightElements[currentHighlightIndex];
        if (prevElement) {
            prevElement.classList.remove('current-highlight');
        }

        // 新しい現在位置を設定
        currentHighlightIndex = index;
        const currentElement = highlightElements[currentHighlightIndex];

        if (currentElement) {
            currentElement.classList.add('current-highlight');
            currentElement.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
    }

    function showHighlightInfo() {
        if (highlightElements.length > 1) {
            // ハイライト情報を表示するバナーを作成
            const infoBanner = document.createElement('div');
            infoBanner.id = 'highlight-info';
            infoBanner.innerHTML = `
                <span>ハイライト ${currentHighlightIndex + 1} / ${highlightElements.length}</span>
                <span>Enterキーで次へ移動</span>
                <button onclick="closeHighlightInfo()">&times;</button>
            `;
            document.body.appendChild(infoBanner);
        }
    }

    function enableHighlightNavigation() {
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && highlightElements.length > 1) {
                e.preventDefault();
                const nextIndex = (currentHighlightIndex + 1) % highlightElements.length;
                scrollToHighlight(nextIndex);
                updateHighlightInfo();
            }
        });
    }

    function updateHighlightInfo() {
        const infoBanner = document.getElementById('highlight-info');
        if (infoBanner) {
            const span = infoBanner.querySelector('span');
            span.textContent = `ハイライト ${currentHighlightIndex + 1} / ${highlightElements.length}`;
        }
    }

    function closeHighlightInfo() {
        const infoBanner = document.getElementById('highlight-info');
        if (infoBanner) {
            infoBanner.remove();
        }
    }

    // ページ読み込み時にハイライト実行
    highlightSearchTerms();
</script>
{{ end }}